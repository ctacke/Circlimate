@page "/"
@inject HttpClient Http

<PageTitle>Circlimate</PageTitle>

<div class="container mt-4">
    <h1>Temperature Circular Chart</h1>

    <div class="row mb-3">
        <div class="col-md-4">
            <label for="cityInput" class="form-label">City</label>
            <input id="cityInput" type="text" class="form-control" @bind="city" @bind:event="oninput" placeholder="Enter city name" />
        </div>
        <div class="col-md-2">
            <label class="form-label">&nbsp;</label>
            <button class="btn btn-primary w-100" @onclick="LoadData" disabled="@isLoading">
                @if (isLoading)
                {
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    <span>Loading...</span>
                }
                else
                {
                    <span>Load Data</span>
                }
            </button>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger" role="alert">
            @errorMessage
        </div>
    }

    @if (temperatureData != null && temperatureData.Any())
    {
        <div class="row">
            <div class="col-12">
                <svg width="800" height="800" viewBox="0 0 800 800" style="border: 1px solid #ccc; background: #f8f9fa;">
                    @* Center point *@
                    <circle cx="400" cy="400" r="2" fill="black" />

                    @* Temperature circles (grid lines) *@
                    @for (int temp = -20; temp <= 40; temp += 10)
                    {
                        var radius = MapTemperatureToRadius(temp);
                        <circle cx="400" cy="400" r="@radius" fill="none" stroke="#ddd" stroke-width="1" />
                        <g>
                            <text x="405" y="@(400 - radius + 5)" font-size="12" fill="#666">@(temp)Â°C</text>
                        </g>
                    }

                    @* Month markers *@
                    @for (int month = 1; month <= 12; month++)
                    {
                        var date = new DateTime(DateTime.Now.Year, month, 1);
                        var dayOfYear = date.DayOfYear;
                        var angle = (dayOfYear / 365.0 * 360.0 - 90) * Math.PI / 180.0; // -90 to start at top
                        var x1 = 400 + Math.Cos(angle) * MaxRadius;
                        var y1 = 400 + Math.Sin(angle) * MaxRadius;
                        var x2 = 400 + Math.Cos(angle) * (MaxRadius + 15);
                        var y2 = 400 + Math.Sin(angle) * (MaxRadius + 15);

                        <line x1="@x1" y1="@y1" x2="@x2" y2="@y2" stroke="#666" stroke-width="2" />

                        var textX = 400 + Math.Cos(angle) * (MaxRadius + 30);
                        var textY = 400 + Math.Sin(angle) * (MaxRadius + 30);
                        <g>
                            <text x="@textX" y="@textY" font-size="14" text-anchor="middle" dominant-baseline="middle" fill="#333">
                                @date.ToString("MMM")
                            </text>
                        </g>
                    }

                    @* Temperature data points - max temperature *@
                    <path d="@GenerateMaxTempPath()" fill="none" stroke="red" stroke-width="2" opacity="0.7" />

                    @* Temperature data points - min temperature *@
                    <path d="@GenerateMinTempPath()" fill="none" stroke="blue" stroke-width="2" opacity="0.7" />

                    @* Legend *@
                    <g transform="translate(650, 50)">
                        <rect x="0" y="0" width="140" height="60" fill="white" stroke="#ccc" stroke-width="1" />
                        <line x1="10" y1="20" x2="40" y2="20" stroke="red" stroke-width="2" />
                        <g><text x="45" y="24" font-size="12" fill="#333">Max Temp</text></g>
                        <line x1="10" y1="40" x2="40" y2="40" stroke="blue" stroke-width="2" />
                        <g><text x="45" y="44" font-size="12" fill="#333">Min Temp</text></g>
                    </g>
                </svg>
            </div>
        </div>

        <div class="mt-3">
            <p><strong>City:</strong> @loadedCity</p>
            <p><strong>Records:</strong> @temperatureData.Count</p>
            <p><strong>Date Range:</strong> @temperatureData.First().Date.ToString("yyyy-MM-dd") to @temperatureData.Last().Date.ToString("yyyy-MM-dd")</p>
        </div>
    }
</div>

@code {
    private string city = "Paris";
    private string loadedCity = "";
    private bool isLoading = false;
    private string? errorMessage = null;
    private List<TemperatureRecord> temperatureData = new();

    private const double CenterRadius = 50;
    private const double MaxRadius = 300;
    private const double MinTemp = -20;
    private const double MaxTemp = 40;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        if (string.IsNullOrWhiteSpace(city))
        {
            errorMessage = "Please enter a city name";
            return;
        }

        isLoading = true;
        errorMessage = null;
        temperatureData.Clear();

        try
        {
            var response = await Http.GetFromJsonAsync<ApiResponse>($"temperature/{Uri.EscapeDataString(city)}");

            if (response?.Records != null)
            {
                temperatureData = response.Records.ToList();
                loadedCity = response.City ?? city;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading data: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private double MapTemperatureToRadius(double temperature)
    {
        // Map temperature from [-20, 40] to [CenterRadius, MaxRadius]
        var normalized = (temperature - MinTemp) / (MaxTemp - MinTemp);
        return CenterRadius + (normalized * (MaxRadius - CenterRadius));
    }

    private (double x, double y) GetPointPosition(int dayOfYear, double temperature)
    {
        var angle = (dayOfYear / 365.0 * 360.0 - 90) * Math.PI / 180.0; // -90 to start at top (0 degrees)
        var radius = MapTemperatureToRadius(temperature);

        var x = 400 + Math.Cos(angle) * radius;
        var y = 400 + Math.Sin(angle) * radius;

        return (x, y);
    }

    private string GenerateMaxTempPath()
    {
        if (!temperatureData.Any()) return "";

        var pathData = new System.Text.StringBuilder();

        for (int i = 0; i < temperatureData.Count; i++)
        {
            var record = temperatureData[i];
            var dayOfYear = record.Date.DayOfYear;
            var (x, y) = GetPointPosition(dayOfYear, record.MaxTemperatureC);

            if (i == 0)
                pathData.Append($"M {x:F2} {y:F2}");
            else
                pathData.Append($" L {x:F2} {y:F2}");
        }

        return pathData.ToString();
    }

    private string GenerateMinTempPath()
    {
        if (!temperatureData.Any()) return "";

        var pathData = new System.Text.StringBuilder();

        for (int i = 0; i < temperatureData.Count; i++)
        {
            var record = temperatureData[i];
            var dayOfYear = record.Date.DayOfYear;
            var (x, y) = GetPointPosition(dayOfYear, record.MinTemperatureC);

            if (i == 0)
                pathData.Append($"M {x:F2} {y:F2}");
            else
                pathData.Append($" L {x:F2} {y:F2}");
        }

        return pathData.ToString();
    }

    private class ApiResponse
    {
        public string? City { get; set; }
        public DateTime StartDate { get; set; }
        public DateTime EndDate { get; set; }
        public int RecordCount { get; set; }
        public TemperatureRecord[]? Records { get; set; }
    }

    private class TemperatureRecord
    {
        public DateTime Date { get; set; }
        public double MaxTemperatureC { get; set; }
        public double MinTemperatureC { get; set; }
        public int ProviderId { get; set; }
    }
}
